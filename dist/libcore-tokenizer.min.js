!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?e(exports,require("libcore")):"function"==typeof define&&define.amd?define(["exports","libcore"],e):e(t["libcore-tokenizer"]={},t.libcore)}(this,function(t,e){"use strict";function n(t){var e={};e[t="string"==typeof t?t:"start"]={not:[]},this.stateGenId=0,this.start=t,this.states=e,this.ends={}}function r(t,e){var n,r,i=t+1,a=i+1,s=x,o=e.substring(i,a);switch(o){case"x":return r=i+2,(n=e.substring(++i,r+1).match(g))?[String.fromCharCode(parseInt(n[0],16)),r]:["x",a];case"u":return r=i+4,(n=e.substring(++i,r+1).match(p))?[String.fromCharCode(parseInt(n[0],16)),r]:["x",a];default:return[o in s?s[o]:o,a]}}function i(t,e){for(var n,r=t,i=e.length;i--;)if("}"===(n=e.charAt(++r))&&(n=e.substring(t+1,r),d.test(n)))return[n,r+1];return null}function a(t,e){var n,a,s,o=Math,l=e.length;if((t=o.max(0,t))>l)return null;if(t===l)return["$$",null,l+1];switch(a=t+1,n=e.charAt(t),s="char",n){case"\\":a=(n=r(t,e))[1],n=n[0],s="char";break;case"{":if(!(n=i(t,e)))throw new Error("Invalid token near "+e.substring(t,o.min(l,t+10)));a=n[1],n=n[0],s="range";break;case"[":if(a<l&&"^"===e.charAt(a)){s="[^",a++;break}case"]":case"(":case")":case"|":case"?":case"+":case"*":case"-":case"^":case"$":s=n}return s?[s,n,a]:null}function s(t){var e,n,r,i,s,o,l,u,c,f,h,g,p=O,d=a,x=w,I=b,S=v,E=m,P=k,$=0,j=0,A=null,C=[],G=0,J=null,N=[null,"("],z=y,_=[],D=0,F=0;for(r=d($,t);r;r=d($,t)){if($=r[2],n=r[1],e=r[0],l=!1,(h=N&&N[1])&&e in(g=z[h])&&(e=g[e]),e in p)switch(e){case"(":case"[":case"[^":l=!!J}else switch(J){case"char":case"]":case"]^":case")":case"+":case"?":case"*":case"range":l=!0}if(l&&(_[D++]=["["===h?",":"[^"===h?"^,":".",null,2,j,0]),"[^"===h)switch(e){case"-":e="^-";break;case"]":e="]^";break;case"char":e="negative_char"}for(_[D++]=[e,n,0,j,$-j],j=$,J=e,i=D-F;i--;F++)if(r=_[F],e=r[0],n=r[1],e in p)switch(s=p[e],c=s[0],u=s[1],c){case P:case E:case S:r[2]=c===S?2:1;t:for(;A;A=A[0]){switch((o=A[1])[0]){case E:case S:if(u<=o[1]){C[G++]=A[2];continue t}}break}c!==P?A=[A,s,r]:C[G++]=r;break;case x:A=[A,s,r],N=[N,e];break;case I:for(;A;A=A[0]){if((o=A[1])[0]===x){if(o[2]!==e)throw new Error("Unmatched token found "+n);f=A[2][3],C[G++]=[s[2],null,1,f,r[3]-f+1],N&&(N=N[0]),A=A[0];break}C[G++]=A[2]}}else C[G++]=r}if(A)throw new Error("Invalid token found "+A[2][1]);return C}function o(){}function l(t){return o.prototype=t,new o}function u(t,e){if(this.id="f"+ ++t.fgen,this.state={id:null},this.builder=t,e){for(this.pointer=e;e.next;e=e.next);this.lastPointer=e,this.outgoing=this.lastOutgoing={fragment:this,next:null}}}function c(t,e){t&&(this.chr=t),this.negative=!0===e}function f(t,e,r){var i,a,o,l,f,h,g,p=u,d=c,x=s(e),w=-1,b=x.length,v=null,m=null,k=0,O=[],I=t+" = /"+e+"/",y={gen:0,fgen:0};for(r instanceof n||(r=new n);b--;)switch(i=x[++w],a=i[0]){case".":v=[v[0][0],v[0][1].link(v[1])];break;case"?":v=[v[0],v[1].split()];break;case"+":v=[v[0],v[1].repeat()];break;case"*":v=[v[0],v[1].split(!0)];break;case"^,":case",":case"|":v=[v[0][0],v[0][1].merge(v[1],"^,"===a)];break;case"^-":case"-":v=[v[0][0],v[0][1].fill(v[1],"^-"===a)];break;case"$$":if(!v||null!==v[0])throw console.warn(v),new Error("Invalid end of expression. "+I);if(l=v[1],f=new p(y,null),l.link(f),g=m.id,(h=f.state.id)===g)throw new Error(S+I);for(O[k++]=h,o=l.splitted;o;o=o.next){if((h=o.fragment.state.id)===g)throw new Error(S+I);O[k++]=h}break;case"^":case"$":case"char":case"negative_char":l=new p(y,new d(i[1],"negative_char"===a)),m||(m=l.applyState()),v=[v,l]}return k&&r.finalizeFragments(t,v[1],O),y=v=o=l=f=null,r}function h(){this.map=new n}n.prototype={constructor:n,generateState:function(t){return e.string(t)?t:"s"+ ++this.stateGenId},finalizeFragments:function(t,e,n){var r,i,a,s,o,l,u,c,f,h,g,p,d,x,w=this,b=this.states,v=this.ends,m={},k={},O=[e],I=1;for(k[e.state.id]=this.start;I--;){a=O[0],O.splice(0,1),(r=k[a.state.id])in b||(b[r]={not:[]}),i=b[r];for(s=a.pointer;s;s=s.next)if(o=s.chr,l=s.to,(f=l.id)in m||(m[f]=!0,O[I++]=l),(r=l.state.id)in k||(k[r]=w.generateState()),r=k[r],s.negative){for(g=d=(p=i.not).length,h=null;g--&&(h=p[g])[0]!==r;)h=null;h||(h=p[d++]=[r,{}]),o in(x=h[1])||(x[o]=1)}else o in i||(i[o]=[]),-1===(u=i[o]).indexOf(r)&&(u[u.length]=r)}for(c=n.length;c--;)v[k[n[c]]]=t},importDefinition:function(t){var n,r=e.object,i=e.string;if(i(t))try{t=JSON.parse(t)}catch(t){throw console.warn(t),new Error("Invalid JSON string parameter.")}if(!r(t))throw new Error("Invalid JSON object parameter.");if(n=t.stateGenId,!e.number(n)||n<0)throw new Error("Invalid state generator");if(this.stateGenId=n,n=t.start,!i(n))throw new Error("Invalid start state name");if(this.start=n,n=t.states,!r(n))throw new Error("Invalid state map object");if(this.states=n,n=t.ends,!r(n))throw new Error("Invalid end states object");return this.ends=n,this},exportDefinition:function(){return{stateGenId:this.stateGenId,start:this.start,states:this.states,ends:this.ends}}};var g=/^[a-fA-F0-9]{2}$/,p=/^[a-fA-F0-9]{4}$/,d=/^([0-9]+|[0-9]+\,[0-9]*|[0-9]*\,[0-9]+)$/,x={b:"\b",f:"\f",n:"\n",r:"\r",t:"\t",v:"\v","\\":"\\",B:"\\"},w=2,b=3,v=4,m=5,k=6,O={"[":[w,15,"]"],"[^":[w,15,"]^"],"]":[b,1,"[]"],"]^":[b,1,"[^]"],"(":[w,15,")"],")":[b,1,"()"],"?":[m,10],"+":[m,10],"*":[m,10],range:[m,10],"-":[v,7],"^-":[v,7],"^,":[v,5],",":[v,5],".":[v,5],"|":[v,3],$$:[k,1]},I={"[":"char","[^":"char","?":"char","+":"char","*":"char",",":"char","|":"char","(":"char",")":"char"},y={"[":I,"[^":I,"(":{"-":"char"}};u.prototype={constructor:u,id:null,state:null,base:null,map:null,splitted:null,repeated:null,pointer:null,lastPointer:null,outgoing:null,lastOutgoing:null,link:function(t){var e,n,r,i,a,s,o,l=this,u=l.outgoing,c=l.splitted,f=t.splitted,h=l.repeated;for(t.applyState();u;u=u.next)u.fragment.pointer.point(t);if(h){for(n=t.lastPointer;h;h=h.next)e=h.pointer,n?n.next=e:t.pointer=e,n=e;t.lastPointer=n}if(i=t.pointer,c&&i){for(a=s=null;c;c=c.next)r=c.fragment,e=i.clone(),(n=r.lastPointer.last()).next=e[0],r.lastPointer=e[1],r.pointer!==l.pointer&&(o={fragment:r,next:null},a?s.next=o:a=o,s=o);s&&(s.next=f,f=a)}return r=l.clone(),r.splitted=f,r.repeated=t.repeated,r.outgoing=t.outgoing,r.lastOutgoing=t.lastOutgoing,r},lastSplit:function(){var t=this.splitted;if(t){for(;t.next;t=t.next);return t}return null},clone:function(){var t=this.base,e=l(this);return t||(e.base=this),e.id="f"+ ++this.builder.fgen,e},split:function(t){var e=this,n=e.splitted,r={fragment:e,next:null},i=e.clone();return t&&i.repeat(),n||(i.splitted=r),i},repeat:function(){var t=this,e=t.pointer;return!t.repeated&&e&&(e=e.clone(),t.repeated={pointer:e[0],next:null}),t},fill:function(t){var e,n=this,r=n.pointer.range(t.pointer);return r?(t.state=n.state,r?r[1].next=t.pointer:r=[t.pointer],n.lastPointer.next=r[0],e=n.clone(),e.lastPointer=t.lastPointer,e.outgoing.next=t.outgoing,e.lastOutgoing=t.lastOutgoing,e):this.merge(t)},merge:function(t){var e,n,r,i=this,a=i.clone();if(t.state=i.state,i.lastPointer.next=t.pointer,i.lastOutgoing.next=t.outgoing,a.lastPointer=t.lastPointer,a.lastOutgoing=t.lastOutgoing,n=i.splitted,e=t.splitted,a.splitted=n||e,n&&e){for(r=n;r.next;r=r.next);r.next=e}if(n=i.repeated,e=t.repeated,a.repeated=n||e,n&&e){for(r=n;r.next;r=r.next);r.next=e}return a},applyState:function(){var t=this.state;return t.id||(t.id="s"+ ++this.builder.gen),t}},c.prototype={constructor:c,negative:!1,repeated:!1,chr:"",to:null,next:null,clone:function(t){var n,r,i=this,a=null,s=l,o=e.assign,u=!1!==t;for(t||(t=null);i&&(n=s(i),t&&o(n,t),a?r.next=n:a=n,r=n,u);i=i.next);return r.next=null,[a,r]},point:function(t){for(var e=this;e;e=e.next)e.to||(e.to=t);return this},last:function(){for(var t=this;t.next;t=t.next);return t},range:function(t){var e,n,r,i=this.chr,a=c,s=String,o=null,l=null,u=this.negative;if(e=i.charCodeAt(0),i=t.chr,t=i.charCodeAt(0),n=Math.max(t-e-1,0)){for(;n--;)r=new a(s.fromCharCode(++e),u),o?l.next=r:o=r,l=r;return o&&[o,l]}return null}};var S="Patterns resulting to empty token is not allowed. ";h.prototype={map:null,constructor:h,define:function(t){var n,r,i,a=e.string,s=e.regex,o=this.map,l=f,u=null;if(!e.array(t))throw new Error("Invalid definitions parameter.");for(r=-1,i=t.length;i--;)if(n=t[++r],a(n))u=n;else if(s(n)){if(n=n.source,!u)throw new Error("Token is not named "+n);l(u,n,o)}return this},fromJSON:function(t){return this.map.importDefinition(t),this},toJSON:function(){return JSON.stringify(this.toObject())},toObject:function(){return this.map.exportDefinition()},tokenize:function(t,e){var n,r,i,a,s,o,l,u,c,f=this.map,h=f.ends,g=f.states,p=[f.start,null],d=e.length,x=d-t,w=t-1,b=null;if(0===x)return["$","",d+1];if(x<1)return null;for(;x--;){for(n=e.charAt(++w),a=null;p;p=p[1]){if(o=p[0],l=g[o],o in h&&(b=[h[o],w]),n in l)for(r=-1,i=(s=l[n]).length;i--;)a=[u=s[++r],a],u in h&&(b=[h[u],w+1]);for(r=-1,i=(c=l.not).length;i--;)n in(u=c[++r])[1]||(a=[u=u[0],a],u in h&&(b=[h[u],w+1]))}if(!a)break;p=a}return b&&(t===(w=b[1])?b=null:(b[2]=w,b[1]=e.substring(t,w))),b}},t.Tokenizer=h,t.default=h,Object.defineProperty(t,"__esModule",{value:!0})});
//# sourceMappingURL=libcore-tokenizer.min.js.map
